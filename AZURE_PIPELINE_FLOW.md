# Azure Pipeline Visual Flow

## Pipeline Architecture

```
???????????????????????????????????????????????????????????????????
?                         TRIGGER                                  ?
?  Push to main/master branch ? Start Pipeline                    ?
???????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????
?                    STAGE 1: BUILD                                ?
???????????????????????????????????????????????????????????????????
?                                                                   ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 1: Checkout Repositories                     ?          ?
?  ?  • Xbl.Web (main repo) ?                         ?          ?
?  ?  • Xbl (dependency repo) ?                       ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 2: Install .NET SDK                         ?          ?
?  ?  • .NET 8.x ?                                    ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 3: Restore NuGet Packages                   ?          ?
?  ?  • Xbl.Web.csproj ?                             ?          ?
?  ?  • Xbl.Function.csproj ?                        ?          ?
?  ?  • Xbl.Web.Shared.csproj ?                      ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 4: Build React App                          ?          ?
?  ?  • Install Node.js 20.x ?                       ?          ?
?  ?  • npm install (Xbl.Web/ClientApp) ?            ?          ?
?  ?  • npm run build ?                              ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 5: Copy React Build                         ?          ?
?  ?  ClientApp/build ? Xbl.Web/wwwroot ?            ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 6: Publish .NET Projects                    ?          ?
?  ?  • dotnet publish Xbl.Web ?                     ?          ?
?  ?  • dotnet publish Xbl.Function ?                ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 7: Create Deployment Packages               ?          ?
?  ?  • Archive Xbl.Web ? XblWebApp.zip ?            ?          ?
?  ?  • Archive Xbl.Function ? XblFunction.zip ?     ?          ?
?  ????????????????????????????????????????????????????          ?
?                         ?                                        ?
?  ????????????????????????????????????????????????????          ?
?  ? Step 8: Upload Artifacts                         ?          ?
?  ?  • 'xbl-web' artifact ?                         ?          ?
?  ?  • 'xbl-function' artifact ?                    ?          ?
?  ????????????????????????????????????????????????????          ?
?                                                                   ?
???????????????????????????????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????????
?                    STAGE 2: DEPLOY                               ?
???????????????????????????????????????????????????????????????????
?                                                                   ?
?  ???????????????????????        ???????????????????????        ?
?  ?  Job 1: Deploy Web  ?        ? Job 2: Deploy Func   ?        ?
?  ???????????????????????        ???????????????????????        ?
?  ?                     ?        ?                     ?        ?
?  ? Download            ?        ? Download            ?        ?
?  ? 'xbl-web'           ?        ? 'xbl-function'      ?        ?
?  ? artifact            ?        ? artifact            ?        ?
?  ?        ?            ?        ?        ?            ?        ?
?  ? Deploy to           ?        ? Deploy to           ?        ?
?  ? Azure Web App       ?        ? Azure Function      ?        ?
?  ? 'xbl'               ?        ? 'xbl-function-app'  ?        ?
?  ?        ?            ?        ?        ?            ?        ?
?  ? ? SUCCESS          ?        ? ? SUCCESS          ?        ?
?  ?                     ?        ?                     ?        ?
?  ???????????????????????        ???????????????????????        ?
?                                                                   ?
???????????????????????????????????????????????????????????????????
                              ?
                        ? COMPLETE
```

## Repository Structure During Build

```
Build Agent Workspace:
?
??? Xbl.Web/                          (Xbl.Web repository)
?   ??? Xbl.Web/
?   ?   ??? ClientApp/                ? React app here now!
?   ?   ?   ??? public/
?   ?   ?   ??? src/
?   ?   ?   ??? package.json
?   ?   ??? Controllers/
?   ?   ??? wwwroot/                  ? React build copied here
?   ?   ??? Program.cs
?   ?   ??? Xbl.Web.csproj
?   ?
?   ??? Xbl.Function/
?   ?   ??? UpdateFunction.cs
?   ?   ??? Program.cs
?   ?   ??? Xbl.Function.csproj
?   ?
?   ??? Xbl.Web.Shared/
?       ??? NullConsole.cs
?       ??? Xbl.Web.Shared.csproj
?
??? Xbl/                              (Xbl repository - dependency)
    ??? Xbl.Client/
    ?   ??? Xbl.Client.csproj
    ??? Xbl.Data/
    ?   ??? Xbl.Data.csproj
    ??? (other projects...)
```

## Deployment Flow

```
????????????????????????????????????????????????????????????????
?                    BUILD ARTIFACTS                            ?
????????????????????????????????????????????????????????????????
?                                                               ?
?  XblWebApp.zip                  XblFunction.zip              ?
?  ??? wwwroot/                   ??? UpdateFunction.cs        ?
?  ?   ??? index.html             ??? host.json               ?
?  ?   ??? static/                ??? local.settings.json     ?
?  ?   ??? (React files)          ??? (Function files)        ?
?  ??? Controllers/                                            ?
?  ??? Program.cs                                              ?
?  ??? (API files)                                             ?
?                                                               ?
????????????????????????????????????????????????????????????????
                         ?                    ?
                         ?                    ?
??????????????????????????????????????????????????????????????
?                    AZURE RESOURCES                          ?
??????????????????????????????????????????????????????????????
?                                                             ?
?  Azure Web App (xbl)           Azure Function (xbl-func)   ?
?  ???????????????????           ????????????????????       ?
?  ? React SPA       ?           ? Timer Trigger    ?       ?
?  ? + REST API      ?           ? (Daily Update)   ?       ?
?  ?                 ?           ?                  ?       ?
?  ? https://xbl     ?           ? Midnight UTC     ?       ?
?  ? .azurewebsites  ?           ? Runs Update()    ?       ?
?  ? .net            ?           ? Downloads Images ?       ?
?  ???????????????????           ????????????????????       ?
?                                                             ?
??????????????????????????????????????????????????????????????
```

## Timeline

```
Trigger ? Build (10-15 min) ? Deploy (5-10 min) ? Complete

0:00  ? Push to GitHub
      ?
0:01  ? Pipeline triggered
      ?
0:02  ? Checkout repos (Xbl.Web + Xbl)
      ?
0:03  ? Install .NET + Node.js
      ?
0:05  ? Restore NuGet packages
      ?
0:07  ? Build React app
      ?
0:10  ? Publish .NET projects
      ?
0:12  ? Create deployment packages
      ?
0:13  ? Upload artifacts
      ?
0:15  ? Start deployment stage
      ?
0:16  ? Deploy Web App
      ?
0:18  ? Deploy Function
      ?
0:20  ? ? Complete!
```

## Multi-Repository Checkout Options

### Option 1: Git Clone (Simple)
```
???????????????????????????????????????
? Azure DevOps Pipeline Agent          ?
???????????????????????????????????????
?                                      ?
? 1. Checkout Xbl.Web (automatic)     ?
?    ?                                 ?
? 2. Run: git clone Xbl.git           ?
?    ?                                 ?
? 3. Both repos available ?           ?
?                                      ?
???????????????????????????????????????
```

### Option 2: Multi-Repo Checkout (Recommended)
```
???????????????????????????????????????
? Azure DevOps Pipeline Agent          ?
???????????????????????????????????????
?                                      ?
? 1. Checkout Xbl.Web (via checkout)  ?
?    ?                                 ?
? 2. Checkout Xbl (via checkout)      ?
?    ?                                 ?
? 3. Both repos available ?           ?
?    More integrated ?                ?
?                                      ?
???????????????????????????????????????
```

## React Build Flow

```
Xbl.Web/ClientApp/
??? package.json
??? public/
?   ??? index.html
??? src/
    ??? App.js
         ?
    [npm install]
         ?
    [npm run build]
         ?
Xbl.Web/ClientApp/build/
??? index.html
??? static/
?   ??? css/
?   ??? js/
??? asset-manifest.json
         ?
    [Copy Files]
         ?
Xbl.Web/wwwroot/          ? Published with Web App
??? index.html
??? static/
```

## Function Deployment Flow

```
Xbl.Function/
??? UpdateFunction.cs
??? Program.cs
??? host.json
??? Xbl.Function.csproj
         ?
  [dotnet publish]
         ?
Build Output/
??? Xbl.Function.dll
??? host.json
??? local.settings.json
??? (dependencies)
         ?
   [Archive to ZIP]
         ?
XblFunction.zip
         ?
  [Deploy to Azure]
         ?
Azure Function App
??? UpdateFunction
    ??? Runs daily at midnight ?
```
