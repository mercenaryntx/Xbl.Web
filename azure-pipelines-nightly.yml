trigger: none

schedules:
- cron: "0 0 * * *"
  displayName: 'Nightly build at midnight UTC'
  branches:
    include:
    - main
  always: true

resources:
  repositories:
  - repository: XblRepo
    type: github
    name: mercenaryntx/Xbl
    ref: main
    endpoint: mercenaryntx

pool:
  vmImage: 'windows-latest'

variables:
buildConfiguration: 'Release'
publishDir: '$(Build.ArtifactStagingDirectory)/publish'
reactBuildDir: 'Xbl.Web/ClientApp/build'
keyVaultName: 'xbl-keyvault'  # Update with your Key Vault name

stages:
- stage: Update
  displayName: 'Update Xbox Live Data'
  jobs:
  - job: UpdateJob
    displayName: 'Run Xbl.Web.Update'
    steps:
    
    # Step 1: Checkout repositories
    - template: pipeline-templates/checkout-repos.yml
    
    # Step 2: Restore NuGet packages
    - template: pipeline-templates/dotnet-restore.yml
    
    # Step 3: Build Xbl.Web.Update
    - task: DotNetCoreCLI@2
      displayName: 'Build Xbl.Web.Update'
      inputs:
        command: 'build'
        projects: '$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web.Update/Xbl.Web.Update.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'
    
    # Step 4: Download live.db from Azure Blob Storage
    - template: pipeline-templates/download-database.yml
    
    # Step 5: Get secrets from Azure Key Vault
    - task: AzureKeyVault@2
      displayName: 'Get secrets from Key Vault'
      inputs:
        azureSubscription: 'xbl'
        KeyVaultName: '$(keyVaultName)'
        SecretsFilter: 'OpenXblApiKey,AzureStorageConnectionString'
        RunAsPreJob: false
    
    # Step 6: Run Xbl.Web.Update with arguments
    - task: PowerShell@2
      displayName: 'Run Xbl.Web.Update'
      inputs:
        targetType: 'inline'
        script: |
          $apiKey = $env:OPENXBLAPIKEY
          $blobConnectionString = $env:AZURESTORAGECONNECTIONSTRING
          $dataFolder = "$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web/data"
          
          if ([string]::IsNullOrWhiteSpace($apiKey)) {
            Write-Error "API Key not found in environment variables"
            exit 1
          }
          
          if ([string]::IsNullOrWhiteSpace($blobConnectionString)) {
            Write-Error "Blob Storage Connection String not found in environment variables"
            exit 1
          }
          
          Write-Host "Running Xbl.Web.Update..."
          Write-Host "Data Folder: $dataFolder"
          
          $exePath = "$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web.Update/bin/$(buildConfiguration)/net8.0/Xbl.Web.Update.exe"
          
          if (-not (Test-Path $exePath)) {
            Write-Error "Xbl.Web.Update.exe not found at: $exePath"
            exit 1
          }
          
          # Run with three arguments: api-key, data-folder, blob-connection-string
          & $exePath $apiKey $dataFolder $blobConnectionString
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Xbl.Web.Update failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "Xbl.Web.Update completed successfully"
      env:
        OPENXBLAPIKEY: $(OpenXblApiKey)
        AZURESTORAGECONNECTIONSTRING: $(AzureStorageConnectionString)
    
    # Step 7: Upload live.db back to Azure Blob Storage
    - template: pipeline-templates/upload-database.yml

- stage: Build
  displayName: 'Build and Package'
  dependsOn: Update
  condition: succeeded()
  jobs:
  - job: BuildJob
    displayName: 'Build Xbl.Web'
    steps:
    
    # Step 1: Checkout repositories
    - template: pipeline-templates/checkout-repos.yml
    
    # Step 2: Restore NuGet packages
    - template: pipeline-templates/dotnet-restore.yml
    
    # Step 3: Build React App
    - template: pipeline-templates/react-build.yml
    
    # Step 4: Download live.db from Azure Blob Storage
    - template: pipeline-templates/download-database.yml
    
    # Step 5: Build and publish Xbl.Web
    - template: pipeline-templates/build-and-publish-web.yml

- stage: Deploy
  displayName: 'Deploy to Azure'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployWebApp
    displayName: 'Deploy Xbl.Web to Azure Web App'
    environment: 'Production'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipeline-templates/deploy-web.yml
