trigger: none

schedules:
- cron: "0 0 * * *"
  displayName: 'Nightly build at midnight UTC'
  branches:
    include:
    - main
  always: true

resources:
  repositories:
  - repository: XblRepo
    type: github
    name: mercenaryntx/Xbl
    ref: main
    endpoint: mercenaryntx

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  publishDir: '$(Build.ArtifactStagingDirectory)/publish'
  reactBuildDir: 'Xbl.Web/ClientApp/build'
  keyVaultName: 'xbl-keyvault'

stages:
- stage: BuildAndDeploy
  displayName: 'Update Data, Build and Deploy'
  jobs:
  - job: UpdateAndBuild
    displayName: 'Update Xbox Live Data & Build Xbl.Web'
    steps:
    
    # Step 1: Checkout repositories
    - template: pipeline-templates/checkout-repos.yml
    
    # Step 2: Get secrets from Azure Key Vault
    - task: AzureKeyVault@2
      displayName: 'Get secrets from Key Vault'
      inputs:
        azureSubscription: 'xbl'
        KeyVaultName: '$(keyVaultName)'
        SecretsFilter: 'OpenXblApiKey,AzureStorageConnectionString'
        RunAsPreJob: false
    
    # Step 3: Restore NuGet packages
    - template: pipeline-templates/dotnet-restore.yml
    
    # Step 4: Build Xbl.Web.Update
    - task: DotNetCoreCLI@2
      displayName: 'Build Xbl.Web.Update'
      inputs:
        command: 'build'
        projects: '$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web.Update/Xbl.Web.Update.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'
    
    # Step 5: Download live.db from Azure Blob Storage
    - template: pipeline-templates/download-database.yml
    
    # Step 6: Run Xbl.Web.Update to update Xbox Live data
    - task: PowerShell@2
      displayName: 'Run Xbl.Web.Update'
      name: RunUpdate
      inputs:
        targetType: 'inline'
        script: |
          $apiKey = $env:OPENXBLAPIKEY
          $blobConnectionString = $env:AZURESTORAGECONNECTIONSTRING
          $dataFolder = "$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web/data"
          
          if ([string]::IsNullOrWhiteSpace($apiKey)) {
            Write-Error "API Key not found in environment variables"
            exit 1
          }
          
          if ([string]::IsNullOrWhiteSpace($blobConnectionString)) {
            Write-Error "Blob Storage Connection String not found in environment variables"
            exit 1
          }
          
          Write-Host "Running Xbl.Web.Update..."
          Write-Host "Data Folder: $dataFolder"
          
          $exePath = "$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web.Update/bin/$(buildConfiguration)/net8.0/Xbl.Web.Update.exe"
          
          if (-not (Test-Path $exePath)) {
            Write-Error "Xbl.Web.Update.exe not found at: $exePath"
            exit 1
          }
          
          # Run with three arguments: api-key, data-folder, blob-connection-string
          & $exePath $apiKey $dataFolder $blobConnectionString 
          $exitCode = $LASTEXITCODE
          
          if ($exitCode -eq 2) {
            Write-Host "##[warning]No new data found. Skipping deployment."
            Write-Host "##vso[task.setvariable variable=HasUpdates;isOutput=true]false"
            exit 0
          }
          elseif ($exitCode -ne 0) {
            Write-Error "Xbl.Web.Update failed with exit code: $exitCode"
            exit $exitCode
          }
          else {
            Write-Host "Xbl.Web.Update completed successfully with new data"
            Write-Host "##vso[task.setvariable variable=HasUpdates;isOutput=true]true"
          }
      env:
        OPENXBLAPIKEY: $(OpenXblApiKey)
        AZURESTORAGECONNECTIONSTRING: $(AzureStorageConnectionString)
    
    # Step 7: Upload updated live.db back to Azure Blob Storage
    - template: pipeline-templates/upload-database.yml
      parameters:
        condition: eq(variables['RunUpdate.HasUpdates'], 'true')
    
    # Step 8: Build React App
    - template: pipeline-templates/react-build.yml
      parameters:
        condition: eq(variables['RunUpdate.HasUpdates'], 'true')
    
    # Step 9: Build Xbl.Web
    - template: pipeline-templates/build-publish-web.yml
      parameters:
        condition: eq(variables['RunUpdate.HasUpdates'], 'true')
    
    # Step 10: Copy updated live.db to publish directory
    - task: CopyFiles@2
      displayName: 'Copy updated live.db to publish directory'
      condition: eq(variables['RunUpdate.HasUpdates'], 'true')
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web/data'
        Contents: 'live.db'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/publish/Xbl.Web/data'
    
    # Step 11: Archive and publish artifact
    - template: pipeline-templates/archive-publish-artifact.yml
      parameters:
        condition: eq(variables['RunUpdate.HasUpdates'], 'true')
  
  # Deployment job - depends on build completing
  - deployment: DeployWebApp
    displayName: 'Deploy Xbl.Web to Azure Web App'
    dependsOn: UpdateAndBuild
    condition: and(succeeded(), eq(dependencies.UpdateAndBuild.outputs['RunUpdate.HasUpdates'], 'true'))
    environment: 'Production'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipeline-templates/deploy-web.yml
