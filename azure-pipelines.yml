trigger:
  branches:
    include:
      - main
      - master

resources:
  repositories:
  - repository: XblRepo
    type: github
    name: mercenaryntx/Xbl
    ref: main
    endpoint: mercenaryntx

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  publishDir: '$(Build.ArtifactStagingDirectory)/publish'
  reactBuildDir: 'Xbl.Web/ClientApp/build'
  keyVaultName: 'xbl-keyvault'  # Update with your Key Vault name

stages:
- stage: Build
  displayName: 'Build and Package'
  jobs:
  - job: BuildJob
    displayName: 'Build Xbl.Web'
    steps:
    
    # Step 1: Checkout repositories
    - template: pipeline-templates/checkout-repos.yml
    
    # Step 2: Restore NuGet packages
    - template: pipeline-templates/dotnet-restore.yml
    
    # Step 3: Build React App
    - template: pipeline-templates/react-build.yml
    
    # Step 4: Get Azure Storage Connection String from Key Vault
    - task: AzureKeyVault@2
      displayName: 'Get Azure Storage Connection String from Key Vault'
      inputs:
        azureSubscription: 'xbl'
        KeyVaultName: '$(keyVaultName)'
        SecretsFilter: 'AzureStorageConnectionString'
        RunAsPreJob: false
    
    # Step 5: Download live.db from Azure Blob Storage
    - template: pipeline-templates/download-database.yml
    
    # Step 6: Build and publish Xbl.Web
    - template: pipeline-templates/build-and-publish-web.yml

- stage: Deploy
  displayName: 'Deploy to Azure'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployWebApp
    displayName: 'Deploy Xbl.Web to Azure Web App'
    environment: 'Production'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipeline-templates/deploy-web.yml
