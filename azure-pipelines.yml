trigger:
branches:
  include:
    - main
    - master
paths:
  exclude:
    - azure-pipelines-nightly.yml
    - Xbl.Web.Update/**

resources:
  repositories:
  - repository: XblRepo
    type: github
    name: mercenaryntx/Xbl
    ref: main
    endpoint: mercenaryntx

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  publishDir: '$(Build.ArtifactStagingDirectory)/publish'
  reactBuildDir: 'Xbl.Web/ClientApp/build'
  keyVaultName: 'xbl-keyvault'

stages:
- stage: Build
  displayName: 'Build and Package'
  jobs:
  - job: BuildJob
    displayName: 'Build Xbl.Web'
    steps:
    
    # Step 1: Checkout repositories
    - template: pipeline-templates/checkout-repos.yml
    
    # Step 2: Restore NuGet packages (Xbl.Web only, excluding Xbl.Web.Update)
    - template: pipeline-templates/dotnet-restore.yml
      parameters:
        solutionPath: '$(Build.SourcesDirectory)/Xbl.Web/Xbl.Web/Xbl.Web.csproj'
    
    # Step 3: Build React App
    - template: pipeline-templates/react-build.yml
    
    # Step 4: Build Xbl.Web
    - template: pipeline-templates/build-publish-web.yml
  
    # Step 5: Get Azure Storage Connection String from Key Vault
    - task: AzureKeyVault@2
      displayName: 'Get Azure Storage Connection String from Key Vault'
      inputs:
        azureSubscription: 'xbl'
        KeyVaultName: '$(keyVaultName)'
        SecretsFilter: 'AzureStorageConnectionString'
        RunAsPreJob: false
    
    # Step 6: Download live.db directly to publish/data directory
    - template: pipeline-templates/download-database.yml
      parameters:
        targetFolder: '$(Build.ArtifactStagingDirectory)/publish/Xbl.Web/data'
        
    # Step 7: Archive and publish artifact
    - template: pipeline-templates/archive-publish-artifact.yml

- stage: Deploy
  displayName: 'Deploy to Azure'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployWebApp
    displayName: 'Deploy Xbl.Web to Azure Web App'
    environment: 'Production'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: pipeline-templates/deploy-web.yml
